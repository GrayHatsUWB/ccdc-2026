<#
    Undo-Hardening.ps1
    
    Use this script if the Hardening script broke something!
    
    1. Finds the LATEST registry backups in C:\ZerologonPatches
    2. Imports them to restore previous registry states
    3. Re-enables the Print Spooler service
    4. Re-enables NetBIOS over TCP/IP
#>

# ========== CRITICAL: Run as Administrator ==========
if (-not ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole] "Administrator")) {
    Write-Host "[!] This script must run as Administrator." -ForegroundColor Red
    exit 1
}

$backupDir = "C:\ZerologonPatches"
Write-Host "[*] STARTING ROLLBACK PROCESS..." -ForegroundColor Yellow
Write-Host ""

# ========== STEP 1: RESTORE REGISTRY BACKUPS ==========
if (Test-Path $backupDir) {
    # Find all .reg files
    $allBackups = Get-ChildItem -Path $backupDir -Filter "Backup-*.reg"
    
    if ($allBackups.Count -gt 0) {
        # Group by timestamp (last 15 chars of filename usually contain timestamp)
        # Assuming format Backup-KEYNAME-yyyyMMdd-HHmmss.reg
        # We just grab the latest file's timestamp to find the 'set'
        $latestFile = $allBackups | Sort-Object LastWriteTime -Descending | Select-Object -First 1
        
        # Extract timestamp from the filename (last 15 chars before .reg)
        # This is a loose match logic, but safer is just to grab all files modified within 1 minute of the last one.
        $latestTime = $latestFile.LastWriteTime
        $recentBackups = $allBackups | Where-Object { ($latestTime - $_.LastWriteTime).TotalMinutes -lt 1 }

        Write-Host "[*] Found $($recentBackups.Count) backup files from $latestTime" -ForegroundColor Cyan
        
        foreach ($file in $recentBackups) {
            Write-Host "    Restoring $($file.Name)..." -ForegroundColor Gray
            Start-Process -FilePath "reg.exe" -ArgumentList "import `"$($file.FullName)`"" -Wait
        }
        Write-Host "[OK] Registry entries restored." -ForegroundColor Green
    }
    else {
        Write-Host "[!] No .reg backup files found in $backupDir!" -ForegroundColor Red
        Write-Host "    Skipping Registry restore. You may need to manually revert LSA/SMB keys." -ForegroundColor Yellow
    }
}
else {
    Write-Host "[!] Backup directory $backupDir does not exist." -ForegroundColor Red
}
Write-Host ""

# ========== STEP 2: REVERT PRINT SPOOLER ==========
Write-Host "[*] Reverting Print Spooler Service..." -ForegroundColor Yellow
try {
    Set-Service -Name Spooler -StartupType Automatic
    Start-Service -Name Spooler
    Write-Host "[OK] Spooler Service set to Automatic and Started." -ForegroundColor Green
}
catch {
    Write-Host "[!] Failed to revert Spooler: $($_.Exception.Message)" -ForegroundColor Red
}
Write-Host ""

# ========== STEP 3: REVERT NETBIOS (NBT-NS) ==========
Write-Host "[*] Reverting NetBIOS settings..." -ForegroundColor Yellow
try {
    $wmi = Get-WmiObject Win32_NetworkAdapterConfiguration | Where-Object { $_.IPEnabled -eq $true }
    foreach ($adapter in $wmi) {
        # 0 = Use NetBIOS setting from the DHCP server (Default/Safe revert)
        # 1 = Enable NetBIOS over TCP/IP
        $adapter.SetTcpipNetbios(0) | Out-Null 
    }
    Write-Host "[OK] NetBIOS set to Default (DHCP) on active adapters." -ForegroundColor Green
}
catch {
    Write-Host "[!] Failed to revert NetBIOS: $($_.Exception.Message)" -ForegroundColor Red
}
Write-Host ""

# ========== STEP 4: MANUAL CLEANUP REMINDER ==========
Write-Host "[*] ROLLBACK SUMMARY" -ForegroundColor Yellow
Write-Host "    If you applied LLMNR or LSA hardening on a machine where the keys" -ForegroundColor Gray
Write-Host "    did NOT exist previously, the registry import may not delete the new keys." -ForegroundColor Gray
Write-Host ""
Write-Host "    If things are still broken, manually check/delete these values:" -ForegroundColor White
Write-Host "    1. HKLM\SOFTWARE\Policies\Microsoft\Windows NT\DNSClient -> Delete 'EnableMulticast'" -ForegroundColor Gray
Write-Host "    2. HKLM\SYSTEM\CurrentControlSet\Control\Lsa -> Delete 'RunAsPPL'" -ForegroundColor Gray
Write-Host ""
Write-Host "[!] PLEASE REBOOT TO APPLY ROLLBACK CHANGES." -ForegroundColor Yellow