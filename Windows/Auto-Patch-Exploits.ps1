<#
    Auto-Patch-Hardening-SmartSMB.ps1
    
    1. Detects OS & Installs Zerologon Patches
    2. Backs up Registry Keys
    3. Enables Netlogon Enforcement (Zerologon)
    4. SMB & Mimikatz Hardening
       * SMART SMB: Only migrates to v3 if v1 is currently active.
    5. Anti-Relay & Anti-Exploit (PrintNightmare, LLMNR, LDAP Signing)
#>

Write-Host "[*] Detecting OS..." -ForegroundColor Cyan
# Using Get-WmiObject for better compatibility with stock Server 2008 R2
$os = Get-WmiObject Win32_OperatingSystem
$caption = $os.Caption
$version = $os.Version
$build = [int]$os.BuildNumber
Write-Host "    Caption : $caption"
Write-Host "    Version : $version"
Write-Host "    Build   : $build"
Write-Host ""

# === KB PACKAGE TABLE - ZEROLOGON PATCHES ===
$kbTable = @(
    @{
        OsMatch  = "Windows Server 2012"
        Packages = @(
            @{ KbId = "KB4571702"; Url = "https://catalog.s.download.windowsupdate.com/d/msdownload/update/software/secu/2020/08/windows8-rt-kb4571702-x64_31d0c26c78ed003e20c197b9f35869069f5f4b56.msu"; Note = "Zerologon patch for Server 2012" }
        )
    },
    @{
        OsMatch  = "Windows Server 2012 R2"
        Packages = @(
            @{ KbId = "KB4571723"; Url = "https://catalog.s.download.windowsupdate.com/c/msdownload/update/software/secu/2020/08/windows8.1-kb4571723-x64_5f366bc88992b43b074421fd9b817c543c93e456.msu"; Note = "Zerologon patch for Server 2012 R2" }
        )
    },
    @{
        OsMatch  = "Windows Server 2016"
        Packages = @(
            @{ KbId = "KB5014026"; Url = "https://catalog.s.download.windowsupdate.com/c/msdownload/update/software/secu/2022/05/windows10.0-kb5014026-x64_df6de35fd472512e628c2acc6e8d58f3e6139ac9.msu"; Note = "SSU for Server 2016" },
            @{ KbId = "KB5013952"; Url = "https://catalog.s.download.windowsupdate.com/d/msdownload/update/software/secu/2022/05/windows10.0-kb5013952-x64_c9c29b4a81897db5545e284f04490c0659dc8b06.msu"; Note = "LCU for Server 2016" }
        )
    },
    @{
        OsMatch  = "Windows Server 2019"
        Packages = @(
            @{ KbId = "KB4566424"; Url = "https://catalog.s.download.windowsupdate.com/d/msdownload/update/software/secu/2020/08/windows10.0-kb4566424-x64_3d5bfb3e572029861cfb02c69de6b909153f5856.msu"; Note = "Zerologon patch for Server 2019" },
            @{ KbId = "KB5068791"; Url = "https://catalog.s.download.windowsupdate.com/c/msdownload/update/software/secu/2025/11/windows10.0-kb5068791-x64_a8b1b1b6c7b6b673c5a5f32772749eb2bb80c88b.msu"; Note = "LCU for Server 2019" }
        )
    }
)

function Get-KBEntryForOS {
    param([string]$Caption, [array]$Table)
    foreach ($entry in $Table) {
        if ($Caption -like "*$($entry.OsMatch)*") { return $entry }
    }
    return $null
}

$kbEntry = Get-KBEntryForOS -Caption $caption -Table $kbTable

# ========== CRITICAL: Run as Administrator ==========
if (-not ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole] "Administrator")) {
    Write-Host "[!] This script must run as Administrator." -ForegroundColor Red
    exit 1
}

$downloadDir = "C:\ZerologonPatches"
if (-not (Test-Path $downloadDir)) { New-Item -Path $downloadDir -ItemType Directory | Out-Null }

# ========== PHASE 1: INSTALL KB PATCHES ==========
if ($kbEntry) {
    Write-Host "[*] PHASE 1: Installing KB patches..." -ForegroundColor Yellow
    foreach ($pkg in $kbEntry.Packages) {
        $kbId = $pkg.KbId
        $kbUrl = $pkg.Url
        $msuPath = Join-Path $downloadDir "$kbId.msu"

        if (-not (Test-Path $msuPath)) {
            Write-Host "[*] Downloading $kbId..." -ForegroundColor Cyan
            try {
                Start-BitsTransfer -Source $kbUrl -Destination $msuPath -ErrorAction Stop
                Write-Host "[*] Downloaded to $msuPath" -ForegroundColor Green
            }
            catch {
                Write-Host "[!] Download failed for $kbId $($_.Exception.Message)" -ForegroundColor Red
                continue
            }
        }
        else {
            Write-Host "[*] $kbId already present at $msuPath" -ForegroundColor Green
        }

        Write-Host "[*] Installing $kbId via wusa..." -ForegroundColor Cyan
        Start-Process -FilePath "wusa.exe" -ArgumentList "`"$msuPath`" /quiet /norestart" -Wait
        Write-Host "[*] wusa completed for $kbId." -ForegroundColor Yellow
    }
}
else {
    Write-Host "[*] PHASE 1: Skipped (No patches defined for this OS)" -ForegroundColor DarkGray
}
Write-Host ""

# ========== PHASE 2: REGISTRY BACKUP ==========
Write-Host "[*] PHASE 2: Backing up Registry Keys..." -ForegroundColor Yellow
$timestamp = Get-Date -Format "yyyyMMdd-HHmmss"

$keysToBackup = @(
    "HKLM\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters",
    "HKLM\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters",
    "HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest",
    "HKLM\SYSTEM\CurrentControlSet\Control\Lsa",
    "HKLM\SOFTWARE\Policies\Microsoft\Windows NT\DNSClient",
    "HKLM\SYSTEM\CurrentControlSet\Services\NTDS\Parameters"
)

foreach ($key in $keysToBackup) {
    $cleanKeyName = $key -replace '\\', '-' -replace ':', ''
    $singleBackup = Join-Path $downloadDir "Backup-$cleanKeyName-$timestamp.reg"
    Start-Process -FilePath "reg.exe" -ArgumentList "export `"$key`" `"$singleBackup`" /y" -Wait -WindowStyle Hidden
    if (Test-Path $singleBackup) {
        Write-Host "    [OK] Backed up $key" -ForegroundColor Gray
    }
}
Write-Host ""

# ========== PHASE 3: ENABLE NETLOGON ENFORCEMENT ==========
Write-Host "[*] PHASE 3: Enabling Netlogon secure channel enforcement..." -ForegroundColor Yellow
$netlogonPath = "HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters"
if (-not (Test-Path $netlogonPath)) { New-Item -Path $netlogonPath -Force | Out-Null }
New-ItemProperty -Path $netlogonPath -Name "FullSecureChannelProtection" -Value 1 -PropertyType DWord -Force | Out-Null
New-ItemProperty -Path $netlogonPath -Name "RestrictNullSessAccess" -Value 1 -PropertyType DWord -Force | Out-Null
Write-Host "[*] Netlogon hardening applied." -ForegroundColor Green
Write-Host ""

# ========== PHASE 4: SMB & MIMIKATZ HARDENING ==========
Write-Host "[*] PHASE 4: SMB Migration and Anti-Mimikatz Hardening..." -ForegroundColor Yellow

# --- 4a. SMART SMB Hardening ---
Write-Host "    [SMB] Checking current protocol status..." -ForegroundColor Cyan
$lanmanPath = "HKLM:\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters"
if (-not (Test-Path $lanmanPath)) { New-Item -Path $lanmanPath -Force | Out-Null }

# Get current SMB1 status
$currentSMB1 = (Get-ItemProperty -Path $lanmanPath -Name "SMB1" -ErrorAction SilentlyContinue).SMB1
$shouldPatchSMB = $false

if ($null -ne $currentSMB1 -and $currentSMB1 -eq 1) {
    # It is explicitly enabled in registry
    Write-Host "    [Check] SMBv1 is explicitly ENABLED (Reg=1)." -ForegroundColor Red
    $shouldPatchSMB = $true
}
elseif ($null -ne $currentSMB1 -and $currentSMB1 -eq 0) {
    # It is explicitly disabled
    Write-Host "    [Check] SMBv1 is already explicitly DISABLED (Reg=0)." -ForegroundColor Green
}
else {
    # Registry key is missing. Deduce status from OS version.
    # OS versions < 10.0 (Server 2012 R2 is 6.3) usually have SMB1 enabled by default.
    # OS versions >= 10.0 (Server 2016/2019) usually have SMB1 disabled/removed by default.
    $osMajor = [version]$version
    if ($osMajor.Major -lt 10) {
        Write-Host "    [Check] SMBv1 key missing on Legacy OS. Assuming ENABLED." -ForegroundColor Red
        $shouldPatchSMB = $true
    }
    else {
        Write-Host "    [Check] SMBv1 key missing on Modern OS. Assuming DISABLED." -ForegroundColor Green
    }
}

if ($shouldPatchSMB) {
    Write-Host "    [ACTION] Migrating SMBv1 -> SMBv3..." -ForegroundColor Yellow
    New-ItemProperty -Path $lanmanPath -Name "SMB1" -Value 0 -PropertyType DWord -Force | Out-Null
    # Enable SMB2 (which also enables SMB3)
    New-ItemProperty -Path $lanmanPath -Name "SMB2" -Value 1 -PropertyType DWord -Force | Out-Null
    Write-Host "    [OK] SMBv1 Disabled / SMBv2 & v3 Enabled." -ForegroundColor Green
}
else {
    Write-Host "    [ACTION] No changes made to SMB protocols." -ForegroundColor Gray
}

# --- 4b. Anti-Mimikatz: WDigest ---
$wdigestPath = "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest"
if (-not (Test-Path $wdigestPath)) { New-Item -Path $wdigestPath -Force | Out-Null }
New-ItemProperty -Path $wdigestPath -Name "UseLogonCredential" -Value 0 -PropertyType DWord -Force | Out-Null
Write-Host "    [OK] UseLogonCredential set to 0." -ForegroundColor Green

# --- 4c. Anti-Mimikatz: LSA Protection ---
$lsaPath = "HKLM:\SYSTEM\CurrentControlSet\Control\Lsa"
if (-not (Test-Path $lsaPath)) { New-Item -Path $lsaPath -Force | Out-Null }
New-ItemProperty -Path $lsaPath -Name "RunAsPPL" -Value 1 -PropertyType DWord -Force | Out-Null
Write-Host "    [OK] RunAsPPL set to 1." -ForegroundColor Green
Write-Host ""

# ========== PHASE 5: ADDITIONAL HARDENING ==========
Write-Host "[*] PHASE 5: Additional Hardening (Print Spooler, LLMNR, LDAP)..." -ForegroundColor Yellow

# --- 5a. Disable Print Spooler ---
Write-Host "    [SPOOLER] Disabling Print Spooler..." -ForegroundColor Cyan
Stop-Service -Name Spooler -Force -ErrorAction SilentlyContinue
Set-Service -Name Spooler -StartupType Disabled
Write-Host "    [OK] Spooler service disabled." -ForegroundColor Green

# --- 5b. Disable LLMNR ---
Write-Host "    [LLMNR] Disabling Multicast Name Resolution..." -ForegroundColor Cyan
$dnsClientPath = "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\DNSClient"
if (-not (Test-Path $dnsClientPath)) { New-Item -Path $dnsClientPath -Force | Out-Null }
New-ItemProperty -Path $dnsClientPath -Name "EnableMulticast" -Value 0 -PropertyType DWord -Force | Out-Null
Write-Host "    [OK] LLMNR Disabled." -ForegroundColor Green

# --- 5c. Disable NetBIOS ---
Write-Host "    [NBT-NS] Disabling NetBIOS over TCP/IP..." -ForegroundColor Cyan
try {
    $wmiNet = Get-WmiObject Win32_NetworkAdapterConfiguration | Where-Object { $_.IPEnabled -eq $true }
    foreach ($adapter in $wmiNet) {
        $adapter.SetTcpipNetbios(2) | Out-Null
    }
    Write-Host "    [OK] NetBIOS Disabled." -ForegroundColor Green
}
catch {
    Write-Host "    [!] Failed to disable NetBIOS: $($_.Exception.Message)" -ForegroundColor Red
}

# --- 5d. Enforce LDAP Signing ---
Write-Host "    [LDAP] Enforcing LDAP Signing..." -ForegroundColor Cyan
$ntdsPath = "HKLM:\SYSTEM\CurrentControlSet\Services\NTDS\Parameters"
if (-not (Test-Path $ntdsPath)) { New-Item -Path $ntdsPath -Force | Out-Null }
New-ItemProperty -Path $ntdsPath -Name "LDAPServerIntegrity" -Value 2 -PropertyType DWord -Force | Out-Null
Write-Host "    [OK] LDAPServerIntegrity set to 2." -ForegroundColor Green

# --- 5e. Disable Unnecessary Services ---
Write-Host "    [SERVICES] Disabling unnecessary background services..." -ForegroundColor Cyan

$servicesToDisable = @(
    "RemoteRegistry",   # Remote Registry Modification
    "Fax",              # Fax Service
    "XblAuthManager",   # Xbox Live Auth Manager
    "XblGameSave",      # Xbox Live Game Save
    "XboxGipSvc",       # Xbox Accessory Management
    "XboxNetApiSvc",    # Xbox Live Networking
    "bthserv",          # Bluetooth Support Service
    "MapsBroker",       # Downloaded Maps Manager
    "lfsvc"             # Geolocation Service
)

foreach ($svc in $servicesToDisable) {
    if (Get-Service -Name $svc -ErrorAction SilentlyContinue) {
        Stop-Service -Name $svc -Force -ErrorAction SilentlyContinue
        Set-Service -Name $svc -StartupType Disabled -ErrorAction SilentlyContinue
        Write-Host "    [OK] $svc disabled." -ForegroundColor Green
    }
    else {
        Write-Host "    [-] $svc not found (Skipping)." -ForegroundColor DarkGray
    }
}
Write-Host ""

Write-Host "[!] IMPORTANT: Reboot the server immediately to finalize all changes!" -ForegroundColor Yellow